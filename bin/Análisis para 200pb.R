### Data analysis from AMPtk 

### In this script we analyze the data generated by the AMPtk program

### Enviroment preparation
library(phyloseq)
library(vegan)
library(ggplot2)
library(ggpubr)

### Import .biom data using phyloseq
sample_200 <- import_biom("../data/taxonomy200.biom")
sample_200
outdir     <- "../output/Taxonomy_200" 

### Inspect the .biom file
head(otu_table(sample_200))  
head(tax_table(sample_200))
head(sample_data(sample_200))

### Rename the columns of the taxa table to the taxonomic hierarchy
colnames(tax_table(sample_200)) <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")

### Check the number of the readings 
no.read=sort(sample_sums(sample_200))
no.read 

###Alpha diversity estimation
### At Phylum level according treatment 
Phylum_treatment <- plot_bar(sample_200, "Treatment", fill = "Phylum") + 
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")
Phylum_treatment

### At Phylum level according host
Phylum_host <- plot_bar(sample_200, "Host", fill = "Phylum") + 
  geom_bar(aes(color=Phylum, fill=Phylum), stat="identity", position="stack")
Phylum_host

### Both in the same graphic 
Figura_Filos <- Phylum_treatment + facet_wrap("Host")
ggsave(path = outdir, "Figura_filos200.png", width = 5, height = 5)

### Because the abundance of readings within a sample cannot be used as a proxy to determine the abundance of Otus, 
### it's better to use a presence-absence table. For this propouse we use the vegan's function decostand, method "pa". 
sample_200_decostand <- decostand(otu_table(sample_200), method="pa")
head(sample_200_decostand)


### The alpha diversity was measure using two metrics, observed and Fisher for diversity using readings (a)
### and decostand function.
### Readings
diversity<- estimate_richness(sample_200, measures =c("Observed", "Fisher"))
diversity

data <- cbind(sample_data(sample_200), diversity)
View(data)
diversity_table_200 <- write.table(data, file="../output/Taxonomy_200/diversity_table_200.tsv", 
                                   quote=FALSE, sep ='\t', col.names = NA)


### Presence-absence
diversity_decostand<- estimate_richness(sample_200_decostand, measures =c("Observed", "Fisher"))
diversity_decostand

data <- cbind(sample_data(sample_200), diversity_decostand)
View(data)
diversity_table_200_decostand <- write.table(data, file="../output/Taxonomy_200/diversity_table_200_decostand.tsv", 
                                   quote=FALSE, sep ='\t', col.names = NA)

### Note: We create two tables, each one with the Observed and Fisher metrics, for readings and decostand function

###  To seee if there is a significant difference between the metrics, an Anova is used
### Anova between Host & Treatment
host_treatment_Fisher <- aov(Fisher~Host*Treatment, data = data)
summary(host_treatment_Fisher)

host_treatment_Observed <- aov(Observed~Host*Treatment, data = data)
summary(host_treatment_Observed)

### Boxplots for Host (Observed and Fisher)
a <- ggplot(data = data, aes(x=Host, y=Observed, fill=Host))+
  geom_boxplot()
b <- ggplot(data = data, aes(x=Host, y=Fisher, fill=Host))+
  geom_boxplot()

# Boxplots for Treatment (Observed and Fisher)
c <- ggplot(data = data, aes(x=Treatment, y=Observed, fill=Host))+
  geom_boxplot()

d <- ggplot(data = data, aes(x=Treatment, y=Fisher, fill=Host))+
  geom_boxplot()

Figura.1 <- ggarrange(a, b, c, d, 
                      labels = c("Huésped/Observada", "Huésped/Fisher", "Tratamiento/Observada", "Tratamiento/Fisher"), 
                      ncol=2, nrow = 2)

ggsave(path = outdir, "Figura_diversidad.png", width = 5, height = 5)

### Beta Diversity
### In order to carry out the analysis of Beta diversity, we need to make ordinations. for example euclidean
euclidean <- distance(sample_200_decostand, method="euclidean")  
euclidean

# Ordination can be done based on dissimilarity table with NMDS
NMDS=ordinate(sample_200_decostand, method = "NMDS", distance=euclidean)
NMDS
sample_200_decostand

### Ordination Plots 
a<- plot_ordination(sample_200, NMDS, color="Host", shape = "Treatment")+
  geom_point(size=2)+
  facet_wrap(~Treatment)+
  theme_bw()

b <- plot_ordination(sample_200, NMDS, color="Host", shape = "Treatment")+
  geom_point(size=2)+
  facet_wrap(~Host)+
  theme_bw()

figure <- ggarrange(a, b, 
                    labels=c("Tratamiento", "Huésped"), 
                    ncol=1, nrow = 2)
figure
ggsave(path = outdir, "Distancia_euclidiana.png", width = 5, height = 5)

